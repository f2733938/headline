<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="expires" content="60">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=0" name="viewport" />
		<title></title>
		<link rel="stylesheet" href="/resources/css/sm.min.css" />
		<link rel="stylesheet" href="/resources/css/reset.css" />
		<link rel="stylesheet" href="/resources/css/css.css" />
		<script type="text/javascript" src="/resources/js/jquery1.11.3.min.js"></script>
		<script type="text/javascript" src="/resources/js/zepto.min.js"></script>
		<script type="text/javascript" src="/resources/js/sm.min.js"></script>
		<script type="text/javascript" src="/resources/base/httpClient.js"></script>
		<script type="text/javascript" src="/resources/js/template.js"></script>
		<script type="text/javascript" src="/resources/applyjs/apply_edit.js"></script>
		<script type="text/javascript" src="/resources/js/exif.js"></script>
		<script type="text/javascript" src="/resources/js/jQuery.Form.js"></script>
		<!--弹窗实现-->
		<link rel="stylesheet" href="/resources/css/weui.min.css"/>
		<link rel="stylesheet" href="/resources/css/jquery-weui.min.css"/>
		<script type="text/javascript" src="/resources/js/jquery-weui.min.js"></script>
		<style>
			input{-webkit-appearance:checkbox}
		</style>
	</head>

	<body>
		<div class="page">
			<header class="bar bar-nav head-bg">
				<a href="javascript:;" class="icon icon-left pull-left" onclick="backIndex()"></a>
				<h1 class="title">修改发布资质</h1>
			</header>
			<div class="content" style="background:#fff">
				<article class="qualificat-item">
					<header>
						<h4>基本信息</h4>
					</header>
					<div class="list-block">
						<ul>
							<li>
								<div class="item-content">
									<div class="item-media"><i class="icon icon-form-name"></i></div>
									<div class="item-inner">
										<div class="item-title label">申请类型</div>
										<div class="item-input">
											<select class="zizhi-style" id="role">
												<option value="DOCTOR">职业医生</option>
												<option value="HOSPITAL">卫生机构</option>
											</select>
										</div>
									</div>
								</div>
							</li>
							<div class="yisheng">
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-email"></i></div>
										<div class="item-inner">
											<div class="item-title label">姓名</div>
											<div class="item-input">
												<input type="text" placeholder="输入您的真实姓名" id="doc_userName">
												<input type="hidden" id="userId"></input>
												<input type="hidden" id="apaId"></input>
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-gender"></i></div>
										<div class="item-inner">
											<div class="item-title label">性别</div>
											<div class="item-input sex-input">
												<span><img src="/resources/images/wxz.png" id="doc_man">男</span>
												<span><img src="/resources/images/yxz.png" id="doc_woman">女</span>
											</div>
										</div>
									</div>
								</li>

								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-calendar"></i></div>
										<div class="item-inner">
											<div class="item-title label">出生日期</div>
											<div class="item-input">
												<input type="date" placeholder="请选择你的出生日期" value="2018-02-22" id="doc_birthday">
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-toggle"></i></div>
										<div class="item-inner">
											<div class="item-title label">身份证号</div>
											<div class="item-input">
												<input type="text" placeholder="输入您的身份证号" id="doc_idCard">
											</div>
										</div>
									</div>
								</li>
								<li class="align-top">
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-comment"></i></div>
										<div class="item-inner">
											<div class="item-title label">工作地区</div>
											<div class="item-input">
												<a href="javascript:;" class="arrow-icon" onclick="changeCity()">
													<input type="text" placeholder="地区信息" readonly="readonly" id="doc_area">
												</a>
											</div>
										</div>
									</div>
								</li>
							</div>
							<div class="qiye" style="display: none;">
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-email"></i></div>
										<div class="item-inner">
											<div class="item-title label">卫生机构</div>
											<div class="item-input">
												<input type="text" placeholder="输入您申请卫生机构全称" id="orgName">
											</div>
										</div>
									</div>
								</li>
								<li class="align-top">
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-comment"></i></div>
										<div class="item-inner">
											<div class="item-title label">所在地区</div>
											<div class="item-input">
												<a href="javascript:;" class="arrow-icon" onclick="changeCity()">
													<input type="text" placeholder="地区信息" readonly="readonly" id="org_area">
												</a>
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-email"></i></div>
										<div class="item-inner">
											<div class="item-title label">运营者</div>
											<div class="item-input">
												<input type="text" placeholder="输入您的真实姓名" id="org_userName">
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-email"></i></div>
										<div class="item-inner">
											<div class="item-title label">手机号</div>
											<div class="item-input">
												<input type="tel" placeholder="输入运营者手机号码" id="org_telephone">
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-gender"></i></div>
										<div class="item-inner">
											<div class="item-title label">性别</div>
											<div class="item-input sex-input">
												<span><img src="/resources/images/wxz.png" id="org_man">男</span>
												<span><img src="/resources/images/yxz.png" id="org_woman">女</span>
												<input type="hidden" id="sex" value="G"></input>
												<input type="hidden" id="applyId"></input>
												<input type="hidden" id="area"></input>
												<!--<input type="hidden" id="userId" name="userId"></input>-->
												<input type="hidden" id="areaCode" name="areaCode"></input>
												<input type="hidden" id="cityCode" name="cityCode"></input>
												<input type="hidden" id="provinceCode" name="provinceCode"></input>
											</div>
										</div>
									</div>
								</li>

								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-calendar"></i></div>
										<div class="item-inner">
											<div class="item-title label">出生日期</div>
											<div class="item-input">
												<input type="date" placeholder="请选择你的出生日期" value="2018-02-22" id="org_birthday">
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="item-content">
										<div class="item-media"><i class="icon icon-form-toggle"></i></div>
										<div class="item-inner">
											<div class="item-title label">身份证号</div>
											<div class="item-input">
												<input type="text" placeholder="输入您的身份证号" id="org_idCard">
											</div>
										</div>
									</div>
								</li>
							</div>
						</ul>
					</div>
				</article>
				<article class="qualificat-item" style="border-top:0.5rem solid #f8f8f8" id="doc_infomation">
					<header>
						<h4>工作信息</h4>
					</header>
					<div class="list-block">
						<ul>
							<li>
								<div class="item-content">
									<div class="item-media"><i class="icon icon-form-toggle"></i></div>
									<div class="item-inner">
										<div class="item-title label">卫生机构</div>
										<div class="item-input">
											<input type="text" placeholder="若不属于下列机构请输入" id="inst-input">
										</div>
									</div>
								</div>
							</li>
							<li>
								<div class="item-content">
									<div class="item-media"><i class="icon icon-form-toggle"></i></div>
									<div class="item-inner">
										<div class="item-title label">科室</div>
										<div class="item-input">
											<input type="text" placeholder="请输入您所在的科室部门" id="doc_division">
										</div>
									</div>
								</div>
							</li>
							<li>
								<div class="item-content">
									<div class="item-media"><i class="icon icon-form-toggle"></i></div>
									<div class="item-inner">
										<div class="item-title label">职称</div>
										<div class="item-input">
											<input type="text" placeholder="请输入您的职位职称" id="doc_title">
										</div>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</article>
				<article class="indent-proof" style="border-top:0.5rem solid #f8f8f8">
					<header>
						<h4>身份证明</h4>
					</header>
					<div id="imageList" class="indent clearfix">
						<form name="uploadImg" id="uploadImg" method="post" enctype ="multipart/form-data">
						</form>
							<article>
							<a href="javascript:;">
								<div id="img1"  > </div>
								<span class="file"><input type="file" id="ID_CARD_POSITIVE" name="ID_CARD_POSITIVE"  />选择文件</span>
								<p class="indent-p">*身份证正面</p>
							</a>
							</article>
							<article class="indent-right">
								<a href="javascript:;">
								<div id="img2"> </div>
									<span class="file"><input type="file" id="ID_CARD_REVERSE" name="ID_CARD_REVERSE" />选择文件</span>
									<p class="indent-p">*身份证反面</p>
								</a>
							</article>
							<article>
								<a href="javascript:;">
								<div id="img3"> </div>
									<span class="file"> <input type="file" id="ID_CARD_HAND" name="ID_CARD_HAND" />选择文件</span>
									<p class="indent-p">*手持身份证正面</p>
								</a>
							</article>
							<article class="indent-right">
								<a href="javascript:;">
								<div id="img4"> </div>
									<span class="file"><input type="file" id="WORK_PROVE" name="WORK_PROVE" />选择文件</span>
									<p class="indent-p" id="licese">*医师从业资格证</p>
								</a>
							</article>
							<article>
								<a href="javascript:;">
								<div id="img5" onclick="remove1()"> </div>
									<span class="file"><input type="file" id="OTHER_PROVE1" name="OTHER_PROVE1" />选择文件</span>
								<input type="text" hidden="hidden" id="imgId1" />
								<input type="text" hidden="hidden" id="imgId2" />
									<p class="indent-p">其他说明证件（1）</p>
								</a>			
							</article>
							<article class="indent-right">
								<a href="javascript:;">
								<div id="img6" onclick="remove2()"> </div>
									<span class="file">	<input type="file" id="OTHER_PROVE2" name="OTHER_PROVE2" />选择文件</span>
									<p class="indent-p">其他说明证件（2）</p>
								</a>
							</article>

					</div>
				</article>
				<div class="qualificate-footer">
					<a href="javascript:;" class="qualificate-btn">提交审核</a>
					<p><input type="checkbox" checked id="rule">仔细阅读并同意<a href="yunying-rule.html">《妇幼宝贝及妇幼头条运营规则》</a>
					</p>
					<small id="content">妇幼头条申请资质说明：凡申请妇幼头条发布人者必须为在职或退休医生、护士等医疗行业从业者，或者医院及保健机构负责人！请上传您的资质证件，通过平台审核后才可发布。</small>
				</div>
			</div>
		</div>
		<script>
			$(function() {
                // 获取页面已有的一个form表单
                var form = document.getElementById("uploadImg");
                // 用表单来初始化
                var formData = new FormData(form);
                /*出生日期显示为当前时间*/
                var now = new Date();
                var day = ("0" + now.getDate()).slice(-2);
                var month = ("0" + (now.getMonth() + 1)).slice(-2);
                var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
                $("#doc_birthday,#org_birthday").val(today);
                var now_date_doc=$("#doc_birthday").val();
                var date1=new Date(now_date_doc.replace(/\-/g, "\/"));
                $("#doc_birthday").change(function (){
                    var date2=new Date($("#doc_birthday").val().replace(/\-/g, "\/"));
                    if(date2>date1){
                        $.alert("出生日期不能大于当前日期");
                        $("#doc_birthday").val(today);
                    }
                })
                var now_date_org=$("#org_birthday").val();
                var date11=new Date(now_date_org.replace(/\-/g, "\/"));
                $("#org_birthday").change(function (){
                    var date22=new Date($("#org_birthday").val().replace(/\-/g, "\/"));
                    if(date22>date11){
                        $.alert("出生日期不能大于当前日期");
                        $("#org_birthday").val(today);
                    }
                })
				$(".sex-input span").click(function() {
					//debugger;
					if($(this).find("img").attr("src") == "/resources/images/wxz.png") {
						$(".sex-input span").find("img").attr("src", "/resources/images/wxz.png");
						$(this).find("img").attr("src", "/resources/images/yxz.png");
						var a = $("#doc_man").attr("src");
						var b = $("#org_man").attr("src");
						if($("#role").val() == "DOCTOR") {
							a = b;
						}
						if(a == "images/yxz.png") {
							$("#sex").val("B");
						} else {
							$("#sex").val("G");
						}
					}
				})
				//监听selecet改变事件
				$(".zizhi-style").on("change", function() {
					if($(this).val() == "HOSPITAL") {
						$(".yisheng").show();
						$("#doc_infomation").show();
						$(".qiye").hide();
						$("#licese").html("*医师从业资格证");
					} else if($(this).val() == "DOCTOR") {
						$(".qiye").show();
						$("#doc_infomation").hide();
						$(".yisheng").hide();
						$("#licese").html("*卫生机构营业执照");
					}
				});
				var userId = $("#userId").val();
				var apaId = $("#applyId").val();
				$(".qualificate-btn").click(function() {
					//debugger;
					if($("input[type='checkbox']").is(':checked')) {

					} else {
						$.alert("请勾选头条运营规则");
						return false;
					}
					//debugger;
					var publishType = $("#role").val();
					var areaCode = $("#areaCode").val();
					var cityCode = $("#cityCode").val();
					var provinceCode = $("#provinceCode").val();
					//医生申请资质
					//debugger;
					if($("#role").val() == "DOCTOR") {
						//获取填写的数据信息

						var userName = $("#doc_userName").val();
						var idCard = $("#doc_idCard").val();
						var orgName = $("#inst-input").val();
						if(orgName == "") {
							orgName = $("#inst-select").val();
						}
						var doc_division = $("#doc_division").val();
						var doc_title = $("#doc_title").val();
						var gender = $("#sex").val();
						var birthday = $("#doc_birthday").val();
						if(userName == "" || idCard == "" || orgName == "" || doc_division == "" || doc_title == "") {
							$.alert("上传信息不完善请完善！");
							return false;
						} else {
							//身份证效验
							if(!isCardNo(idCard)) {
								return false;
							}
							//姓名字数效验
							if(userName.length > 10) {
								("姓名不符合规范!");
								return false;
							}
							//卫生机构字数效验
							if(orgName.length > 20 || doc_division.length > 20 || doc_title.length > 20) {
								$.alert("工作信息部分字数过长");
								return false;
							}
						}
					} else {
						//机构申请资质
						//debugger;
						var userName = $("#orgName").val();
						var orgName = $("#org_userName").val();
						var mobile = $("#org_telephone").val();
						var birthday = $("#org_birthday").val();
						var idCard = $("#org_idCard").val();
						var gender = $("#sex").val();
						var birthday = $("#org_birthday").val();
						if(userName == "" || orgName == "" || org_telephone == "" || birthday == "" || idCard == "") {
							$.alert("上传信息不完善请完善！");
							return false;
						} else {
							//身份证效验
							if(!isCardNo(idCard)) {
								return false;
							}
							//姓名字数效验
							if(userName.length > 10) {
                                $.alert("姓名不符合规范!");
								return false;
							}
							//卫生机构字数效验
							if(orgName.length > 20) {
                                $.alert("卫生机构字数过长");
								return false;
							}
							//手机号码效验
							if(!isPoneAvailable(mobile)) {
								return false;
							}
						}
					}
				
					//验证通过后执行申请流程接口
					//使用jquery.form插件上传
				//debugger;		
                    /*				var iD_CARD_POSITIVE = $("#ID_CARD_POSITIVE").val();
                                    //alert(iD_CARD_POSITIVE);
                                    var iD_CARD_REVERSE = $("#ID_CARD_REVERSE").val();
                                    var iD_CARD_HAND = $("#ID_CARD_HAND").val();
                                    var wORK_PROVE = $("#WORK_PROVE").val();
                                    var oTHER_PROVE1 = $("#OTHER_PROVE1").val();
                                    var oTHER_PROVE2 = $("#OTHER_PROVE2").val();
                                    if(oTHER_PROVE1 == ""){
                                        $("#OTHER_PROVE1").remove();
                                    }
                                    if(oTHER_PROVE2 == ""){
                                        $("#OTHER_PROVE2").remove();
                                    }
                                    if(iD_CARD_POSITIVE == ""){
                                        $("#ID_CARD_POSITIVE").remove();
                                    }
                                    if(iD_CARD_REVERSE == ""){
                                        $("#ID_CARD_REVERSE").remove();
                                    }
                                    if(iD_CARD_HAND == ""){
                                        $("#ID_CARD_HAND").remove();
                                    }
                                    if(wORK_PROVE == ""){
                                        $("#WORK_PROVE").remove();
                                    }
                                var options = {
                                  type:'post',           //post提交
                                  url:sanmi.serverUrl+"/headline/publisher/apply/update",   //url
                                  dataType:"json",        //json格式
                                  data:{'userName':userName,
                                          'publishType': publishType,
                                            'gender': gender,
                                            'birthday': birthday,
                                            'idCard': idCard,
                                            'province': provinceCode,
                                            'city': cityCode,
                                            'area': areaCode,
                                            'orgName': orgName,
                                            'section': doc_division,
                                            'title': doc_title,
                                            'mobile': mobile,
                                            'userId':userId,
                                            'applyId':apaId,
                                  },    //如果需要提交附加参数，视情况添加
                                  clearForm: true,        //成功提交后，清除所有表单元素的值
                                  resetForm: true,        //成功提交后，重置所有表单元素的值
                                  cache:false,
                                  async:false,          //同步返回
                                  success:function(data){
                                    //服务器端返回处理逻辑
                                    console.info(data);
                                    var applyId = data.info;
                                    $("#applyId").val(applyId);
                                    if(publishType == "HOSPITAL"){
                                        window.location.href="/view/operators-qualification-apply-result.html?userId="+userId;
                                    }else{
                                        window.location.href="/view/qualification-apply-result.html?userId="+userId;
                                    }
                                  },
                                  error:function(XmlHttpRequest,textStatus,errorThrown){
                                      if(publishType == "HOSPITAL"){
                                          window.location.href="/view/operators-qualification-apply-result.html?userId="+userId;
                                      }else{
                                          window.location.href="/view/qualification-apply-result.html?userId="+userId;
                                      }
                                  }
                                };
                                $('#uploadImg').ajaxSubmit(options);*/
                    formData.append("userName",userName);
                    formData.append("publishType",publishType);
                    formData.append("gender",gender);
                    formData.append("birthday",birthday);
                    formData.append("idCard",idCard);
                    formData.append("province",provinceCode);
                    formData.append("city",cityCode);
                    formData.append("area",areaCode);
                    formData.append("orgName",orgName);
                    formData.append("section",doc_division);
                    formData.append("title",doc_title);
                    formData.append("mobile",mobile);
                    formData.append("userId",userId);
                    formData.append("applyId",apaId);
                    //  formData.append("ID_CARD_POSITIVE",$('#ID_CARD_POSITIVE').get(0).files[0]);
                    $.ajax({
                        type:"post" ,
                        data: formData,
                        /* {
                            formData
                           'userName':userName,
                                'publishType': publishType,
                            'gender': gender,
                            'birthday': birthday,
                            'idCard': idCard,
                            'province': provinceCode,
                            'city': cityCode,
                            'area': areaCode,
                            'orgName': orgName,
                            'section': doc_division,
                            'title': doc_title,
                            'mobile': mobile,
                        },*/
                        // dataType : "json",
                        contentType: false,
                        processData: false,
                        url: sanmi.serverUrl+"/headline/publisher/apply/update",
                        success: function(data){
                            $.modal({
                                title: "上传状态",
                                text: "资质申请修改成功!",
                                buttons: [
                                    { text: "查看详情", onClick: function(){
                                            if(publishType == "HOSPITAL"){
                                                window.location.href="/view/operators-qualification-apply-result.html?userId="+userId;
                                            }else{
                                                window.location.href="/view/qualification-apply-result.html?userId="+userId;
                                            }
                                            // window.location.href="/view/qualification-apply.html?userId="+userId+ "&area=370102";
                                        } },
                                    { text: "返回主页", className: "default", onClick: function(){
                                            window.location.href="/view/index.html";
                                        } },
                                ]
                            });
                        },
                        error : function(data){
                            $.alert("系统繁忙,请稍后再试")
                        }
                    });
				});
                $("#ID_CARD_POSITIVE").change(function(e) {
                    var file = e.target.files[0];
                    //实例化FileReader API
                    //获取照片的拍摄方向
                    //var orient = getPhotoOrientation(file);
                    var freader = new FileReader();
                    freader.readAsDataURL(file);
                    freader.onload = function(e) {
                        $("#img1").attr("style","background-image:url('"+e.target.result+"')");
                        console.log(e.target);
                        //大于200K,压缩
                        //加载图片获取图片真实宽度和高度
                        var image = new Image();
                        image.onload=function(){
                            var width = image.width;
                            var height = image.height;
                            //alert(width+'======'+height+"====="+file.size);
                            //       if(e.target.result.length > 204800){
                            //  图片加载完毕之后进行压缩，然后上传
                            var data = callback(image);
                            console.log("base64是:"+data);
                            // 将以base64的图片url数据转换为Blob
                            var blob = convertBase64UrlToBlob(data);
                            console.log("blob是:"+blob);
                            formData.append('ID_CARD_POSITIVE', blob);
                            //   }
                        };
                        image.src= e.target.result;
                    }
                });
                $("#ID_CARD_REVERSE").change(function(e) {
                    var file = e.target.files[0];
                    //实例化FileReader API
                    //获取照片的拍摄方向
                    //var orient = getPhotoOrientation(file);
                    var freader = new FileReader();
                    freader.readAsDataURL(file);
                    freader.onload = function(e) {
                        $("#img2").attr("style","background-image:url('"+e.target.result+"')");
                        console.log(e.target);
                        //大于200K,压缩
                        //加载图片获取图片真实宽度和高度
                        var image = new Image();
                        image.onload=function(){
                            var width = image.width;
                            var height = image.height;
                            //  alert(width+'======'+height+"====="+file.size);
                            //    if(e.target.result.length > 204800){
                            //  图片加载完毕之后进行压缩，然后上传
                            var data = callback(image);
                            console.log("base64是:"+data);
                            // 将以base64的图片url数据转换为Blob
                            var blob = convertBase64UrlToBlob(data);
                            console.log("blob是:"+blob);
                            formData.append('ID_CARD_REVERSE', blob);
                            //  }
                        };
                        image.src= e.target.result;
                    }
                });
                $("#ID_CARD_HAND").change(function(e) {
                    var file = e.target.files[0];
                    //实例化FileReader API
                    //获取照片的拍摄方向
                    //var orient = getPhotoOrientation(file);
                    var freader = new FileReader();
                    freader.readAsDataURL(file);
                    freader.onload = function(e) {
                        $("#img3").attr("style","background-image:url('"+e.target.result+"')");
                        console.log(e.target);
                        //大于200K,压缩
                        //加载图片获取图片真实宽度和高度
                        var image = new Image();
                        image.onload=function(){
                            var width = image.width;
                            var height = image.height;
                            // alert(width+'======'+height+"====="+file.size);
                            //        if(e.target.result.length > 204800){
                            //  图片加载完毕之后进行压缩，然后上传
                            var data = callback(image);
                            console.log("base64是:"+data);
                            // 将以base64的图片url数据转换为Blob
                            var blob = convertBase64UrlToBlob(data);
                            console.log("blob是:"+blob);
                            formData.append('ID_CARD_HAND', blob);
                            //          }
                        };
                        image.src= e.target.result;
                    }
                });
                $("#WORK_PROVE").change(function(e) {
                    var file = e.target.files[0];
                    //实例化FileReader API
                    //获取照片的拍摄方向
                    //var orient = getPhotoOrientation(file);
                    var freader = new FileReader();
                    freader.readAsDataURL(file);
                    freader.onload = function(e) {
                        $("#img4").attr("style","background-image:url('"+e.target.result+"')");
                        console.log(e.target);
                        //大于200K,压缩
                        //加载图片获取图片真实宽度和高度
                        var image = new Image();
                        image.onload=function(){
                            var width = image.width;
                            var height = image.height;
                            //    alert(width+'======'+height+"====="+file.size);
                            //       if(e.target.result.length > 204800){
                            //  图片加载完毕之后进行压缩，然后上传
                            var data = callback(image);
                            console.log("base64是:"+data);
                            // 将以base64的图片url数据转换为Blob
                            var blob = convertBase64UrlToBlob(data);
                            console.log("blob是:"+blob);
                            formData.append('WORK_PROVE', blob);
                            //    }
                        };
                        image.src= e.target.result;
                    }
                });
                $("#OTHER_PROVE1").change(function(e) {
                    var file = e.target.files[0];
                    //实例化FileReader API
                    //获取照片的拍摄方向
                    //var orient = getPhotoOrientation(file);
                    var freader = new FileReader();
                    freader.readAsDataURL(file);
                    freader.onload = function(e) {
                        $("#img5").attr("style","background-image:url('"+e.target.result+"')");
                        console.log(e.target);
                        //大于200K,压缩
                        //加载图片获取图片真实宽度和高度
                        var image = new Image();
                        image.onload=function(){
                            var width = image.width;
                            var height = image.height;
                            //    alert(width+'======'+height+"====="+file.size);
                            //        if(e.target.result.length > 204800){
                            //  图片加载完毕之后进行压缩，然后上传
                            var data = callback(image);
                            console.log("base64是:"+data);
                            // 将以base64的图片url数据转换为Blob
                            var blob = convertBase64UrlToBlob(data);
                            console.log("blob是:"+blob);
                            formData.append('OTHER_PROVE1', blob);
                            //         }
                        };
                        image.src= e.target.result;
                    }
                });
                $("#OTHER_PROVE2").change(function(e) {
                    var file = e.target.files[0];
                    //实例化FileReader API
                    //获取照片的拍摄方向
                    //var orient = getPhotoOrientation(file);
                    var freader = new FileReader();
                    freader.readAsDataURL(file);
                    freader.onload = function(e) {
                        $("#img6").attr("style","background-image:url('"+e.target.result+"')");
                        console.log(e.target);
                        //大于200K,压缩
                        //加载图片获取图片真实宽度和高度
                        var image = new Image();
                        image.onload=function(){
                            var width = image.width;
                            var height = image.height;
                            //  alert(width+'======'+height+"====="+file.size);
                            //           if(e.target.result.length > 204800){
                            //  图片加载完毕之后进行压缩，然后上传
                            var data = callback(image);
                            console.log("base64是:"+data);
                            // 将以base64的图片url数据转换为Blob
                            var blob = convertBase64UrlToBlob(data);
                            console.log("blob是:"+blob);
                            formData.append('OTHER_PROVE1', blob);
                            //          }
                        };
                        image.src= e.target.result;
                    }
                });
			})

			function isCardNo(card) {
				// 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X 
				var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
				if(reg.test(card) === false) {
                    $.alert("身份证输入不合法");
					return false;
				} else {
					return true;
				}
			}

			function isPoneAvailable(str) {
				var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
				if(!myreg.test(str)) {
                    $.alert("手机号输入不合法");
					return false;
				} else {
					return true;
				}
			}
			//处理返回值
			function followHander(json) {
				var status = json.status;
				//console.info(status);
				if(status == "0") {
                    $.alert(json.msg);
					//sanmi.toPage("/index.html");
					return;
				}
				//debugger;
				var publishType = $("#role").val();
				var userId = $("#userId").val();
				if(publishType == 'DOCTOR') {
					window.location.href = "/view/qualification-apply-result.html?userId=" + userId;
				} else {
					window.location.href = "/view/operators-qualification-apply-result.html?userId=" + userId;
				}
			}
			function changeCity(){
				//debugger;
				var userId = $("#userId").val();
				var area = $("#areaCode").val();
				var org_area = $("#org_area").val();
				window.location.href="/view/city.html?area="+area+"&userId="+userId+"&areaName="+encodeURI(encodeURI(org_area))+"&areaLevel=3";
			}
			function backIndex(){
				var userId = $("#userId").val();
				window.location.href="/view/index.html?userId="+userId+"&recommend";
			}			

			function remove1(){  
                $("#img5").attr("style","");  
				var oTHER_PROVE1 = $("#OTHER_PROVE1").val("");
				var imgId1 = $("#imgId1").val();
				// debugger;
				if(imgId1 == ""){
					return false;
				}
					var param = {
					url: '/headline/publisher/apply/deleteImages',
					data: {
						'ids': imgId1,
					},
					method: 'post',
					dataType: 'json',
					callback: 'deleteStatusHander',
				}
				sanmi.query(param);
        }
			function remove2(e){  
                $("#img6").attr("style","");   
                var oTHER_PROVE2 = $("#OTHER_PROVE2").val("");   
				var imgId2 = $("#imgId2").val();
				if(imgId2 == ""){
					return false;
				}
					var param = {
					url: '/headline/publisher/apply/deleteImages',
					data: {
						'ids': imgId2,
					},
					method: 'post',
					dataType: 'json',
					callback: 'deleteStatusHander',
				}
				sanmi.query(param);                
        }     
        function deleteStatusHander(json){
        		var status = json.status;
				//console.info(status);
				if(status == "0") {
                    $.alert(json.msg);
					//sanmi.toPage("/index.html");
					return;
				}
        }
            function callback(img) {
                var data = compress(img);
                // $("#img1").attr("style","background-image:url('"+data+"')");
                img = null;
                return data;
            };
            function compress(img) {
                var initSize = img.src.length;
                var width = img.width;
                var height = img.height;
                console.log("图片的宽为"+width);
                console.log("图片的高为"+height);
                //如果图片大于四百万像素，计算压缩比并将大小压至400万以下
                var ratio;
                if ((ratio = width * height / 4000000)>1) {
                    ratio = Math.sqrt(ratio);
                    width /= ratio;
                    height /= ratio;
                }else {
                    ratio = 1;
                }
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext("2d");
                canvas.width = width;
                canvas.height = height;

//        铺底色
                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                //如果图片像素大于100万则使用瓦片绘制
                var count;
                if ((count = width * height / 1000000) > 1) {
                    count = ~~(Math.sqrt(count)+1); //计算要分成多少块瓦片

//            计算每块瓦片的宽和高
                    var nw = ~~(width / count);
                    var nh = ~~(height / count);
                    var tCanvas = document.createElement("canvas");
                    var tctx = tCanvas.getContext("2d");
                    tCanvas.width = nw;
                    tCanvas.height = nh;

                    for (var i = 0; i < count; i++) {
                        for (var j = 0; j < count; j++) {
                            tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);

                            ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
                        }
                    }
                } else {
                    ctx.drawImage(img, 0, 0, width, height);
                }

                //进行最小压缩
                var ndata = canvas.toDataURL('image/jpeg', 0.1);

                console.log('压缩前：' + initSize);
                console.log('压缩后：' + ndata.length);
                console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");

                tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;

                return ndata;
            }
            //获取照片的元信息（拍摄方向）
            function getPhotoOrientation(img){
                var orient;
                EXIF.getData(img, function () {
                    orient = EXIF.getTag(this, 'Orientation');
                });
                return orient;
            }

            /**
             * 将以base64的图片url数据转换为Blob
             * @param urlData
             * 用url方式表示的base64图片数据
             */
            function convertBase64UrlToBlob(urlData){

                var bytes=window.atob(urlData.split(',')[1]);        //去掉url的头，并转换为byte
                var type = urlData.split('/')[1].split(';')[0];
                console.log(type);
                //处理异常,将ascii码小于0的转换为大于0
                var ab = new ArrayBuffer(bytes.length);
                var ia = new Uint8Array(ab);
                for (var i = 0; i < bytes.length; i++) {
                    ia[i] = bytes.charCodeAt(i);
                }
                return getBlob( [ab] , type);
            }
            /**
             * 获取blob对象的兼容性写法
             * @param buffer
             * @param format
             * @returns {*}
             */
            function getBlob(buffer, format) {
                try {
                    return new Blob(buffer, {type: format});
                } catch (e) {
                    var bb = new (window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
                    buffer.forEach(function(buf) {
                        bb.append(buf);
                    });
                    return bb.getBlob(format);
                }
            }

		</script>
	</body>

</html>